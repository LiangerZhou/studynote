> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 https://mp.weixin.qq.com/s?__biz=MzIxMjE5MTE1Nw==&mid=2653192625&idx=1&sn=cbabbd806e4874e8793332724ca9d454&chksm=8c99f36bbbee7a7d169581dedbe09658d0b0edb62d2cbc9ba4c40f706cb678c7d8c768afb666&scene=21#wechat_redirect

点击上方 “程序员小灰”，选择 “置顶公众号”

有趣有内涵的文章第一时间送达！

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpSh0QibEB0lG2JJC5gsycdGibQHBuAvQRvrtOB5g9lqRJocrdsf8rnficxKg/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpShOAQgXwlUmH0V7HOLTpnmicXfptVaq882ALCp45DkMlib6X9rJjIq2sVA/0?wx_fmt=jpeg)

**—————  第二天  —————**

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGqqUO6KYNSJy5OOBA9TZjKt0RC8QnoOahl9MSGG01mQk35laaRwmIT4A8IWHnmFFy7vKNicXoJDGibA/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGqqUO6KYNSJy5OOBA9TZjKtSKFImWLnRGUNI1Ct4FRoC8ZsX0wflMBqEjJqFdof43317OiaGicydjkA/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGr3vzqSAic4tBXwdITnhZv68WIYUI3bPLMhIs04t426GCgZiacQSAtAYFO9z1J72ngFGTArqvUUeDeA/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGr3vzqSAic4tBXwdITnhZv68DTbkR7teZDicWtHrXomft6Aue9ptePOFwH04nGrBJGa5vDGdTKDNSJw/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGqVfRYia0icE4MX9lsEmibTgel4aZFN8sbcicuqRECDmACnUl1AByWD5o0hXsg8Ozw6kxmos0J5EqKdcQ/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGr3vzqSAic4tBXwdITnhZv680ustYBtYCl8dxq0p83azDfWG5YBQOOlDTjScSUegAwFJyQhEglcicWA/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGr3vzqSAic4tBXwdITnhZv68sJrhSicfHiboMO7LChVUXUHdKeM6Ip7PGFQI8kY2ViavoHcicU1lzUjPzw/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGr3vzqSAic4tBXwdITnhZv68bQ6m0ZXUQOo2yibgFTDgByZ3DaoWO4dhXuojwuWpHABsdMx88ZWIWzA/0?wx_fmt=jpeg)

————————————

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGqxkFpyXIna0Fw7VUh9ib2qlLiaokKmL2tWuicYAcTJngQL5hcJX8r1AyT6J37Jqj9ckbBt6fx12DvFA/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGqxkFpyXIna0Fw7VUh9ib2qlsUrxsPDnk5cwnwshzsIdAUM0Kk6B3bZXXK4ROV1eEreU9Gly5VHa1g/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpShFaLt5FibP3l6t5cyBGuyzXDoerKancoAelSXDY3mAQNmhwJJD6xRUkQ/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpShfthquuv7gicj5SmQgBpovSvLqq87iceVzodoKgOZS5hB8zug1wyVCOjQ/0?wx_fmt=jpeg)

示例程序：启动两个线程，每个线程中让静态变量 count 循环累加 100 次。

![](http://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpfMM4tNG7D3k05o337rpShZXiak0BsdNRAtaS6k9SfJjdFpjffTZMK2r1sH3b66fyUalkDDyk9qnQ/0?wx_fmt=png)

最终输出的 count 结果是什么呢？一定会是 200 吗？

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpShIKIcANj3TPK2uPZ9gchyU5BsNP0c5sKBrxKD9Jf1RbW08gryrr9VKw/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpShlicibr9px2ylGRHmZP03MzZg8WPLrDL77l6M1NUZSiadJSo0gDiaB1zBibQ/0?wx_fmt=jpeg)

加了同步锁之后，count 自增的操作变成了原子性操作，所以最终的输出一定是 **count=200**，代码实现了线程安全。  

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpSh7oyLA55EEbA0AYUHLgRL4yIrsLsp9QLeov3vxA4Y6EcGZSuU6IAKCw/0?wx_fmt=jpeg)

为什么这么说呢？关键在于**性能**问题。

Synchronized 关键字会让没有得到锁资源的线程进入 **BLOCKED** 状态，而后在争夺到锁资源后恢复为 **RUNNABLE** 状态，这个过程中涉及到操作系统**用户模式**和**内核模式**的转换，代价比较高。

尽管 Java1.6 为 Synchronized 做了优化，增加了从**偏向锁**到**轻量级锁**再到**重量级锁**的过度，但是在最终转变为重量级锁之后，性能仍然较低。

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpShibke60ZSQ8jQuoQMdXK7fcyLkkDGS2EfOiahzQQS9DPHmjsXcB8ibWKdg/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpShGGRXbCRnGex6AobAMaQw1mDsg1rOnq7Ht6BIBZwO8ATgyuBicHl7AnQ/0?wx_fmt=jpeg)

所谓原子操作类，指的是 java.util.concurrent.atomic 包下，一系列以 Atomic 开头的包装类。例如 **AtomicBoolean**，**AtomicInteger**，**AtomicLong**。它们分别用于 Boolean，Integer，Long 类型的原子性操作。

现在我们尝试在代码中引入 AtomicInteger 类：

![](http://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpfMM4tNG7D3k05o337rpShribQotvjDuDlyicxS2dia4ALrX34qkicCy8IIsltj0DEAsPYPPcnhtYC9g/0?wx_fmt=png)

使用 AtomicInteger 之后，最终的输出结果同样可以保证是 200。并且在**某些情况下**，代码的性能会比 Synchronized 更好。

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpShB3BNoHpSEU4ciaxM0ZibygONia0Bl1nics0CiaSzbgWcXdrRQiavtJgSddLg/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpShKYXCt1er4rM7GmfW6N8CibticQhhgt7x3sohrIkdcbtXT38xWgcuYGJw/0?wx_fmt=jpeg)

**什么是 CAS？**

CAS 是英文单词 **Compare And Swap** 的缩写，翻译过来就是比较并替换。

CAS 机制当中使用了 3 个基本操作数：内存地址 V，旧的预期值 A，要修改的新值 B。

更新一个变量的时候，只有当变量的预期值 A 和内存地址 V 当中的实际值相同时，才会将内存地址 V 对应的值修改为 B。

这样说或许有些抽象，我们来看一个例子：

1. 在内存地址 V 当中，存储着值为 10 的变量。

![](http://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpfMM4tNG7D3k05o337rpShOeJLljhERkvqp67jVabfCav7JavW187K3LRY2ctJgPMGR3CwwjEpmw/0?wx_fmt=png)

2. 此时线程 1 想要把变量的值增加 1。对线程 1 来说，旧的预期值 A=10，要修改的新值 B=11。

![](http://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpfMM4tNG7D3k05o337rpShqdLARaWkhjkxBtj3ATLfv5dWH5IdkC6aS9Z1yF9Uwzxgo9JoDvjlicA/0?wx_fmt=png)

3. 在线程 1 要提交更新之前，另一个线程 2 抢先一步，把内存地址 V 中的变量值率先更新成了 11。

![](http://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpfMM4tNG7D3k05o337rpShPITYwPKKy02I0pXyhpcRfxEic3WoBfLssdj1ZTKJZLD7hjXmKulFaicw/0?wx_fmt=png)

4. 线程 1 开始提交更新，首先进行 **A 和地址 V 的实际值比较（Compare）**，发现 A 不等于 V 的实际值，提交失败。

![](http://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpfMM4tNG7D3k05o337rpShkJYyyq1ibjU6C24EMGia3aSsh70PVJSqtviaGfuMvSiadsuOrLMPribYCMg/0?wx_fmt=png)

5. 线程 1 重新获取内存地址 V 的当前值，并重新计算想要修改的新值。此时对线程 1 来说，A=11，B=12。这个重新尝试的过程被称为**自旋**。

![](http://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpfMM4tNG7D3k05o337rpShaV90ic19WkNFJtgwObDrdRhC0rmjCTY8cPMTT1AQzib0MzAZkgkRgkag/0?wx_fmt=png)

6. 这一次比较幸运，没有其他线程改变地址 V 的值。线程 1 进行 **Compare**，发现 A 和地址 V 的实际值是相等的。

![](http://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpfMM4tNG7D3k05o337rpShoAervdbw7FAx7UTUiboumNxXMBnY4giaj4m4vtnoNmCWWaiay0ygaYXcQ/0?wx_fmt=png)

7. 线程 1 进行 **SWAP**，把地址 V 的值替换为 B，也就是 12。

![](http://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpfMM4tNG7D3k05o337rpShcmWtgnZwGHdhLu91mPUibnKq1bAs7UdyHO7F01h2Jrs4pib17riaa2YaA/0?wx_fmt=png)

从思想上来说，Synchronized 属于**悲观锁**，悲观地认为程序中的并发情况严重，所以严防死守。CAS 属于**乐观锁**，乐观地认为程序中的并发情况不那么严重，所以让线程不断去尝试更新。

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpSh4HJtMiciaDRF19QSicPy16Irw5fhLW0AXsJFFhEyAdoSohybGU5DHRduQ/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpShbBicN7kCERSTfoWZOVYO9Xdcib4PI6YzfXOOcykSanRBSicehRbHA7Slw/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpShuMLXJw5AoIOmib1D5icFWIpaIib6XCQvfDKiaBxvibJib7ZvFrYK2eK8jrIA/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpShXvsypQiaOPYfiaE28vBRiaSIHnCibic6kvy5bZp9iaoXuhTdacxoYruc5Jxw/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpShluuH1WgFEobwZVNHg2ttBz7KVXZdosiaMltboZmCCCgpaTkZjRvxFkg/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpShLAQaZWBGGBH6ut3kBx1o2dF7vwqjndHRCenPfupOK5W5C6MEYpwQzg/0?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpfMM4tNG7D3k05o337rpShjM8Roia8rwZZnLbhTV6bNMx36r9SgtrQOPZhBK4Bj0Tth2Q38geTwPw/0?wx_fmt=jpeg)

**CAS 的缺点：**

**1.CPU 开销较大**

在并发量比较高的情况下，如果许多线程反复尝试更新某一个变量，却又一直更新不成功，循环往复，会给 CPU 带来很大的压力。

**2. 不能保证代码块的原子性**

CAS 机制所保证的只是一个变量的原子性操作，而不能保证整个代码块的原子性。比如需要保证 3 个变量共同进行原子性的更新，就不得不使用 Synchronized 了。

**3.ABA 问题**

这是 CAS 机制最大的问题所在。

什么是 **ABA** 问题？怎么解决？我们下一期来详细介绍。

**几点补充：**

**本漫画纯属娱乐，还请大家尽量珍惜当下的工作，切勿模仿小灰的行为哦。**

—————END—————

喜欢本文的朋友们，欢迎长按下图关注订阅号**程序员小灰**，收看更多精彩内容

![](http://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGoBj18gILw2hefgpNaCia1eRhNCzRx29e1DpVhicyenCic4RQibDTbzySoqqpOrmBxu7KlLZM73YDDPJg/640?wx_fmt=jpeg)